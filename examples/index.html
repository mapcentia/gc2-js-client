<!doctype html>
<html lang="en">
<head>
    <title>GC2 JS Client - SPA Example</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <script src="../dist/centia-io-sdk.umd.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>

<nav class="navbar navbar-expand-lg bg-body-tertiary">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">GC2 SPA</a>
        <div class="d-flex">
            <button class="btn btn-primary me-2" id="login-btn" style="display: none">Login</button>
            <button class="btn btn-outline-secondary" id="logout-btn" style="display: none">Logout</button>
        </div>
    </div>
</nav>

<div class="container my-4" id="main">
    <div class="card mb-3">
        <div class="card-header">Authentication</div>
        <div class="card-body">
            <div class="row g-2 align-items-end">
                <div class="col-sm-4">
                    <label class="form-label">Host</label>
                    <input id="host" class="form-control" value="http://localhost:8080"/>
                </div>
                <div class="col-sm-4">
                    <label class="form-label">Client ID</label>
                    <input id="clientId" class="form-control" value="gc2-cli"/>
                </div>
                <div class="col-sm-4">
                    <label class="form-label">Redirect URI</label>
                    <input id="redirectUri" class="form-control" value="http://localhost:63342/gc2-js-client/examples/index.html"/>
                </div>
            </div>
            <div class="mt-3">
                <small class="text-muted">Adjust the settings if needed, then click Login. After returning from the identity provider, this page handles the callback automatically.</small>
            </div>
            <div class="mt-3">
                <span id="auth-status" class="badge text-bg-secondary">Signed out</span>
            </div>
        </div>
    </div>

    <div class="card" id="tables-card" style="display: none;">
        <div class="card-header">Manage Tables</div>
        <div class="card-body">
            <div class="row g-2">
                <div class="col-sm-4">
                    <label class="form-label">Schema</label>
                    <input id="schema" class="form-control" placeholder="public"/>
                </div>
                <div class="col-sm-4">
                    <label class="form-label">Table</label>
                    <input id="table" class="form-control" placeholder="my_table"/>
                </div>
            </div>
            <div class="mt-3">
                <label class="form-label">Payload (JSON for create/patch)</label>
                <textarea id="payload" class="form-control" rows="6" placeholder='{"comment":"Optional table props"}'></textarea>
            </div>
            <div class="mt-3 d-flex gap-2 flex-wrap">
                <button id="btn-get" class="btn btn-outline-primary">Get</button>
                <button id="btn-create" class="btn btn-success">Create</button>
                <button id="btn-patch" class="btn btn-warning">Patch</button>
                <button id="btn-delete" class="btn btn-danger">Delete</button>
            </div>
            <div class="mt-3">
                <label class="form-label">Response</label>
                <pre id="output" class="bg-light p-3" style="min-height: 150px; white-space: pre-wrap"></pre>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
<script>
    // Initialize CodeFlow using inputs so users can adapt config
    let codeFlow;
    let tablesApi;


    const $ = (sel) => document.querySelector(sel);
    const setAuthUI = (signedIn) => {
        $('#login-btn').style.display = signedIn ? 'none' : 'inline-block';
        $('#logout-btn').style.display = signedIn ? 'inline-block' : 'none';
        $('#auth-status').textContent = signedIn ? 'Signed in' : 'Signed out';
        $('#auth-status').className = signedIn ? 'badge text-bg-success' : 'badge text-bg-secondary';
        $('#tables-card').style.display = signedIn ? 'block' : 'none';
    };

    const initCodeFlow = () => {
        const redirectUri = $('#redirectUri').value.trim();
        const clientId = $('#clientId').value.trim();
        const host = $('#host').value.trim();
        codeFlow = new CentiaSDK.CodeFlow({ redirectUri, clientId, host, scope: 'openid' });
        tablesApi = new CentiaSDK.Tables();

        $('#login-btn').onclick = () => codeFlow.signIn();
        $('#logout-btn').onclick = () => { codeFlow.signOut(); location.reload(); };
    };

    initCodeFlow();

    // Handle auth callback and UI state
    codeFlow.redirectHandle().then(isSignedIn => {
        setAuthUI(isSignedIn);
    }).catch(err => {
        console.error(err);
        setAuthUI(false);
    });

    // Helpers
    const readPayload = () => {
        const txt = $('#payload').value.trim();
        if (!txt) return null;
        try { return JSON.parse(txt); } catch (e) { throw new Error('Payload is not valid JSON'); }
    };
    const readInputs = () => {
        const schema = $('#schema').value.trim();
        const table = $('#table').value.trim();
        if (!schema || !table) throw new Error('Schema and table are required');
        return { schema, table };
    };
    const show = (obj) => { $('#output').textContent = (typeof obj === 'string') ? obj : JSON.stringify(obj, null, 2); };

    // Wire up CRUD buttons
    $('#btn-get').onclick = async () => {
        try {
            const {schema, table} = readInputs();
            const res = await tablesApi.get(schema, table);
            show(res);
        } catch (e) { show(e.message || String(e)); }
    };
    $('#btn-create').onclick = async () => {
        try {
            const {schema, table} = readInputs();
            const payload = readPayload();
            const res = await tablesApi.create(schema, table, payload);
            show(res);
        } catch (e) { show(e.message || String(e)); }
    };
    $('#btn-patch').onclick = async () => {
        try {
            const {schema, table} = readInputs();
            const payload = readPayload();
            const res = await tablesApi.patch(schema, table, payload);
            show(res);
        } catch (e) { show(e.message || String(e)); }
    };
    $('#btn-delete').onclick = async () => {
        try {
            const {schema, table} = readInputs();
            const res = await tablesApi.delete(schema, table);
            show('Deleted (204 No Content)');
        } catch (e) { show(e.message || String(e)); }
    };
</script>
</body>
</html>
